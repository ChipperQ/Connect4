# Miguel Quime
# Connect Four

require 'gosu'

class Game
	module Pattern
		Won = 
		[[(/RRRR....................................../),:R],	[(/BBBB....................................../),:B],	[(/R......R......R......R..................../),:R],	[(/B......B......B......B..................../),:B],	[(/R.......R.......R.......R................./),:R],	[(/..B.......B.......B.......B.............../),:B],	[(/......B.....B.....B.....B................./),:B],
		[(/.RRRR...................................../), :R],	[(/.BBBB...................................../),:B],	[(/.......R......R......R......R............./),:R],	[(/.......B......B......B......B............./),:B],	[(/........R.......R.......R.......R........./),:R],	[(/..........B.......B.......B.......B......./),:B],	[(/............B.....B.....B.....B.........../),:B],
		[(/..RRRR..................................../), :R],	[(/..BBBB..................................../),:B],	[(/..............R......R......R......R....../),:R],	[(/..............B......B......B......B....../),:B],	[(/................R.......R.......R.......R./),:R],	[(/...B.......B.......B.......B............../),:B],	[(/..................B.....B.....B.....B...../),:B],
		[(/...RRRR.................................../), :R],	[(/...BBBB.................................../),:B],	[(/.R......R......R......R.................../),:R],	[(/.B......B......B......B.................../),:B],	[(/.R.......R.......R.......R................/),:R],	[(/...R.....R.....R.....R..................../),:R],	[(/.............B.....B.....B.....B........../),:B],
		[(/.......RRRR.............................../), :R],	[(/.......BBBB.............................../),:B],	[(/........R......R......R......R............/),:R],	[(/........B......B......B......B............/),:B],	[(/.........R.......R.......R.......R......../),:R],	[(/....R.....R.....R.....R.................../),:R],	[(/...................B.....B.....B.....B..../),:B],
		[(/........RRRR............................../), :R],	[(/........BBBB............................../),:B],	[(/...............R......R......R......R...../),:R],	[(/...............B......B......B......B...../),:B],	[(/.................R.......R.......R.......R/),:R],	[(/..........R.....R.....R.....R............./),:R],	[(/....................B.....B.....B.....B.../),:B],
		[(/.........RRRR............................./), :R],	[(/.........BBBB............................./),:B],	[(/..R......R......R......R................../),:R],	[(/..B......B......B......B................../),:B],	[(/..............R.......R.......R.......R.../),:R],	[(/.....R.....R.....R.....R................../),:R],
		[(/..........RRRR............................/), :R],	[(/..........BBBB............................/),:B],	[(/.........R......R......R......R.........../),:R],	[(/.........B......B......B......B.........../),:B],	[(/.......R.......R.......R.......R........../),:R],	[(/...........R.....R.....R.....R............/),:R],
		[(/..............RRRR......................../), :R],	[(/..............BBBB......................../),:B],	[(/................R......R......R......R..../),:R],	[(/................B......B......B......B..../),:B],	[(/...............R.......R.......R.......R../),:R],	[(/.................R.....R.....R.....R....../),:R],
		[(/...............RRRR......................./), :R],	[(/...............BBBB......................./),:B],	[(/...R......R......R......R................./),:R],	[(/...B......B......B......B................./),:B],	[(/..R.......R.......R.......R.............../),:R],	[(/......R.....R.....R.....R................./),:R],
		[(/................RRRR....................../), :R],	[(/................BBBB....................../),:B],	[(/..........R......R......R......R........../),:R],	[(/..........B......B......B......B........../),:B],	[(/..........R.......R.......R.......R......./),:R],	[(/............R.....R.....R.....R.........../),:R],
		[(/.................RRRR...................../), :R],	[(/.................BBBB...................../),:B],	[(/.................R......R......R......R.../),:R],	[(/.................B......B......B......B.../),:B],	[(/...R.......R.......R.......R............../),:R],	[(/..................R.....R.....R.....R...../),:R],
		[(/.....................RRRR................./), :R],	[(/.....................BBBB................./),:B],	[(/....R......R......R......R................/),:R],	[(/....B......B......B......B................/),:B],	[(/B.......B.......B.......B................./),:B],	[(/.............R.....R.....R.....R........../),:R],
		[(/......................RRRR................/), :R],	[(/......................BBBB................/),:B],	[(/...........R......R......R......R........./),:R],	[(/...........B......B......B......B........./),:B],	[(/........B.......B.......B.......B........./),:B],	[(/...................R.....R.....R.....R..../),:R],
		[(/.......................RRRR.............../), :R],	[(/.......................BBBB.............../),:B],	[(/..................R......R......R......R../),:R],	[(/..................B......B......B......B../),:B],	[(/................B.......B.......B.......B./),:B],	[(/....................R.....R.....R.....R.../),:R],
		[(/........................RRRR............../), :R],	[(/........................BBBB............../),:B],	[(/.....R......R......R......R.............../),:R],	[(/.....B......B......B......B.............../),:B],	[(/.B.......B.......B.......B................/),:B],	[(/...B.....B.....B.....B..................../),:B],
		[(/............................RRRR........../), :R],	[(/............................BBBB........../),:B],	[(/............R......R......R......R......../),:R],	[(/............B......B......B......B......../),:B],	[(/.........B.......B.......B.......B......../),:B],	[(/....B.....B.....B.....B.................../),:B],
		[(/.............................RRRR........./), :R],	[(/.............................BBBB........./),:B],	[(/...................R......R......R......R./),:R],	[(/...................B......B......B......B./),:B],	[(/.................B.......B.......B.......B/),:B],	[(/..........B.....B.....B.....B............./),:B],
		[(/..............................RRRR......../), :R],	[(/..............................BBBB......../),:B],	[(/......R......R......R......R............../),:R],	[(/......B......B......B......B............../),:B],	[(/..............B.......B.......B.......B.../),:B],	[(/.....B.....B.....B.....B................../),:B],
		[(/...............................RRRR......./), :R],	[(/...............................BBBB......./),:B],	[(/.............R......R......R......R......./),:R],	[(/.............B......B......B......B......./),:B],	[(/.......B.......B.......B.......B........../),:B],	[(/...........B.....B.....B.....B............/),:B],
		[(/...................................RRRR.../), :R],	[(/...................................BBBB.../),:B],	[(/....................R......R......R......R/),:R],	[(/....................B......B......B......B/),:B],	[(/...............B.......B.......B.......B../),:B],	[(/.................B.....B.....B.....B....../),:B],
		[(/....................................RRRR../), :R],	[(/....................................BBBB../),:B],
		[(/.....................................RRRR./), :R],	[(/.....................................BBBB./),:B],
		[(/......................................RRRR/), :R], [(/......................................BBBB/),:B],]
	end
	attr_reader :players, :board, :board_move, :current_player
	def initialize
		@players = {:player1 => 'R', :player2 => 'B'}
    @board = [].fill(0,42) {" "}
		@current_player = @players[:player1]
	end

	def make_move(pmove)
		  @move = @pmove = pmove
			last_row = 35
      stack_row = 7
			@move += last_row
			while occupied?()
				@move -= stack_row
				break if @move < 0
			end
			if is_valid_move == true
				 @board[@move] = @current_player
			else
				puts "Invalid"
        false
			end
	end
	
	def occupied?
		if @board[@move] == " "
			return false
		else
			return true
		end
	end
	
	def is_valid_move()
		if @pmove >= 0 && @pmove < 7 && occupied? == false 
			return true
		else 
			return false
		end
	end

	def switch_player()
		if @current_player == 'R' 
			@current_player = @players[:player2]
		else 
			@current_player = @players[:player1]
		end
	end

	def check_for_win()
		@winner = nil
		w = Pattern::Won.find {|p| p.first =~ @board.join}
			if w 
				@winner = (w.last === :R) ? 'R' : 'B'
				return true
			end
			false
	end
  
	def game_tie?()
		if @board.include?(" ") == false
			return true
		end
	end

	def end_game()
		if check_for_win() then
			return true
	  end
  end
  
end

class GameWindow < Gosu::Window
  	def initialize
  		super 541, 465, false
  		self.caption = "Connect 4"
  		@controller = Game.new()
  		@text = Gosu::Font.new(self, Gosu::default_font_name, 15)
  		@background_image = Gosu::Image.new(self, "c4board.png", true)
      @black_piece = Gosu::Image.new(self, "blackp.png", true)
      @green_piece = Gosu::Image.new(self, 'green.png', true)
      @green_winning_piece = Gosu::Image.new(self, 'green_winner.png', true)
      @black_winning_piece = Gosu::Image.new(self, 'black_winner.png', true)
      @no_winner = Gosu::Image.from_text(self, "'esc' = Leave game. 'spacebar' = Restart game.", "Bold", 28)
  	end

  	def needs_cursor?
  		true
    end
        
   def index_from_mouse_location()
      x1 = 1
      x2 = 77
      row = 7
      @column_index = ((mouse_x.to_i-x1)/x2)
      @row_index = (row*(((mouse_y.to_i)-x1)/x2))
      @index = @column_index + @row_index
    end
    
    def location_from_index(index)
      @column = (index%7)
      @row = (index/7)
      return [(@column*77)+5, (@row*77)+5]
    end
    
  	def reset_if_replay()
  		@controller = Game.new()
  	end     

    def button_down(id)
    	close if id == Gosu::KbEscape
      reset_if_replay() if id == Gosu::KbSpace
      if id == Gosu::MsLeft
        if @controller.end_game() || @controller.game_tie?()
         nil
        else
          location_from_index(index_from_mouse_location())
          if @controller.make_move(@column)
            @controller.end_game()
            @controller.switch_player() unless @controller.end_game()
          end
        end
      else
        puts "Only left clicks." unless id == Gosu::KbEscape || id == Gosu::KbSpace
      end
    end    

    def draw()
      @background_image.draw(0, 0, 0)
      for index in 0..41
        if @controller.board[index] == "R"
          (x,y) = location_from_index(index)
          @green_piece.draw(x,y,0)
        elsif @controller.board[index] == "B"
          (x,y) = location_from_index(index)
          @black_piece.draw(x,y,0)
        end
      end
      
      if @controller.game_tie?()
        @no_winner.draw(18,60,0)
      end
      
      if @controller.end_game()
        if @controller.current_player == 'R'
          @green_winning_piece.draw(120,75,0)
        elsif @controller.current_player == 'B'
          @black_winning_piece.draw(120,75,0)
        end 
      end
    end
    
  end
  
  window = GameWindow.new
  window.show
